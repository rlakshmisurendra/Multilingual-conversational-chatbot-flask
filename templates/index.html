<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UniLingo</title>
  <link rel="icon" type="image/svg+xml" href="/static/unilingo-logo.svg" />
  <style>
    :root{
      --bg: #f5f7fb; /* light gray canvas per screenshot */
      --panel: #ffffff;
      --border: #e6e8f0;
      --muted: #6b7280;
      --text: #1f2937;
      --accent: #5B6BFF; /* screenshot blue */
      --bubble-user: #eef2ff;
      --bubble-assistant: #ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg)}

    .app{display:flex; min-height:100vh; width:100%;}
    .sidebar{background:var(--panel); border-right:1px solid var(--border); padding:18px; display:flex; gap:16px; flex-direction:column; min-height:100vh; width:320px; flex-shrink:0}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:18px}
    .brand img{width:28px; height:28px}

    /* New chat pill */
    .new-chat{display:flex; align-items:center; justify-content:center; gap:10px; height:44px; border-radius:999px; color:#fff; background:var(--accent); border:none; cursor:pointer; font-weight:700; box-shadow:0 12px 26px rgba(91,107,255,.3)}
    .new-chat svg{width:18px;height:18px; stroke:#fff; stroke-width:2; fill:none}

    /* User info block */
    .user-info{display:flex; align-items:center; gap:10px; padding:12px; border:1px solid var(--border); border-radius:12px; background:#f8fafc}
    .user-info .user-avatar{width:38px; height:38px; border-radius:999px; background:linear-gradient(135deg,#60a5fa,#2563eb); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:800}
    .user-meta{display:flex; flex-direction:column; gap:2px}
    .user-name{font-weight:700}

    .history{display:flex; flex-direction:column; gap:6px; max-height:40vh; overflow:auto}
    .history a{display:block; padding:10px 12px; border-radius:10px; color:inherit; text-decoration:none; border:1px solid transparent}
    .history a:hover{background:#f8fafc; border-color:var(--border)}

    .nav-links{display:flex; flex-direction:column; gap:8px}
    .side-btn{display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; text-decoration:none; color:inherit; font-weight:600}
    .side-btn:hover{background:#f8fafc}

    .spacer{flex:1}
    .user-card{border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff}
    .user-card .email{color:var(--muted); font-size:12px}
    .logout{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer}

    .chat{display:grid; grid-template-rows:auto 1fr auto; height:100vh; width:100%}
    .chat-header{display:flex; align-items:center; justify-content:space-between; padding:14px 20px}
    .title-row{display:flex; align-items:center; gap:10px}
    .logo-dot{width:24px; height:24px; border-radius:999px; background:radial-gradient(circle at 30% 30%, #ff80b5, #8b5cf6)}
    .chat-title{font-weight:800; font-size:20px}
    .chat-sub{font-size:12px; color:var(--muted)}

    .chat-area{overflow-y:auto; overflow-x:hidden; padding:24px; display:flex; flex-direction:column; gap:14px}
    .row{display:flex; gap:10px; align-items:flex-end}
    .row.user{justify-content:flex-end}
    .avatar{width:28px; height:28px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800; color:#fff; background:linear-gradient(135deg,#2dd4bf,#6366f1)}
    .avatar.user{background:linear-gradient(135deg,#60a5fa,#2563eb)}
    .bubble{max-width:820px; padding:14px 16px; border-radius:18px; border:1px solid var(--border); background:var(--bubble-assistant); box-shadow:0 1px 6px rgba(0,0,0,.05)}
    .bubble.user{background:var(--bubble-user); border-color:#dfe4ff}
    .actions{display:flex; gap:8px; margin-top:6px; opacity:.0; transition:opacity .2s ease}
    .row:hover .actions{opacity:1}
    .chip{border:1px solid var(--border); background:#fff; padding:4px 8px; border-radius:999px; font-size:12px; cursor:pointer}

    .composer{display:flex; gap:12px; padding:12px 16px; background:transparent; border-top:none; align-items:center}
    .composer textarea{flex:1; resize:none; height:44px; max-height:100px; padding:12px 16px; border:1px solid #e5e7eb; border-radius:20px; font-size:14px; background:#f3f4f6; color:#1f2937; font-family:'Inter', system-ui, sans-serif; line-height:20px; overflow:hidden; -ms-overflow-style:none; scrollbar-width:none}
    .composer textarea::-webkit-scrollbar{display:none}
    .composer textarea::placeholder{color:#9ca3af}
    .composer textarea:focus{outline:none; background:#fff; border-color:#667eea; box-shadow:0 0 0 2px rgba(102, 126, 234, 0.1)}
    .composer button{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:50%; width:40px; height:40px; min-width:40px; padding:0; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; transition:all 0.2s; flex-shrink:0}
    .composer button:hover:not(:disabled){transform:scale(1.05); box-shadow:0 4px 12px rgba(102, 126, 234, 0.4)}
    .composer button:disabled{opacity:.5; cursor:not-allowed; transform:scale(1)}

    @media (max-width: 960px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
    }
  </style>
  <script type="module" src="/static/firebase-init.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js';

    const app = initializeApp(window.firebaseConfig);
    const auth = getAuth(app);

    let idToken = null;

    const chatEl = () => document.getElementById('chat');
    const inputEl = () => document.getElementById('message');
    const sendBtn = () => document.getElementById('send');
    const logoutBtn = () => document.getElementById('logout');
    const adminLinkEl = () => document.getElementById('admin-link');
    const whoEl = () => document.getElementById('whoami');
    const nameEl = () => document.getElementById('user-name');
    const avatarEl = () => document.getElementById('user-avatar');

    function addMsg(role, text) {
      const row = document.createElement('div');
      row.className = 'row ' + (role === 'user' ? 'user' : 'assistant');

      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role === 'user' ? 'user' : 'assistant');
      avatar.textContent = role === 'user' ? 'U' : 'AI';

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
      bubble.textContent = text;

      const actions = document.createElement('div');
      actions.className = 'actions';
      const copyBtn = document.createElement('button');
      copyBtn.className = 'chip';
      copyBtn.textContent = 'Copy';
      copyBtn.onclick = async () => { await navigator.clipboard.writeText(text); copyBtn.textContent = 'Copied'; setTimeout(()=> copyBtn.textContent='Copy', 1200); };
      actions.appendChild(copyBtn);

      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.flexDirection = 'column';
      wrap.appendChild(bubble);
      wrap.appendChild(actions);

      if (role === 'user') {
        row.appendChild(wrap);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(wrap);
      }

      chatEl().appendChild(row);
      chatEl().scrollTop = chatEl().scrollHeight;
    }

    async function api(path, body) {
      let res = await fetch(path, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken,
        },
        body: JSON.stringify(body || {})
      });
      if (res.status === 401) {
        try {
          const data = await res.json();
          // Check if session expired
          if (data.detail && data.detail.includes('Session expired')) {
            alert('Your session has expired. Please sign in again.');
            window.location.href = '/login';
            return res;
          }
        } catch (e) {}
        
        // Try refreshing token and retry once on unauthorized
        if (auth.currentUser) {
          idToken = await auth.currentUser.getIdToken(true);
          res = await fetch(path, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + idToken,
            },
            body: JSON.stringify(body || {})
          });
        }
      }
      return res;
    }

    async function sendMessage() {
      const text = inputEl().value.trim();
      if (!text || !idToken) return;
      addMsg('user', text);
      inputEl().value = '';
      try {
        const res = await api('/api/chat', { message: text });
        let data = null;
        try { data = await res.json(); } catch {}
        if (!res.ok) {
          const detail = data && (data.detail || data.error) ? ` (detail: ${data.detail || data.error})` : '';
          throw new Error(`Request failed${detail}`);
        }
        addMsg('assistant', data.reply);
      } catch (e) {
        addMsg('assistant', 'Error: ' + e.message);
      }
    }

    function handleKey(e){
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const display = user.displayName || user.email || user.uid;
        whoEl().textContent = user.email || user.uid;
        nameEl().textContent = display || 'Signed in';
        avatarEl().textContent = (display || 'U').charAt(0).toUpperCase();
        idToken = await user.getIdToken(true);
        checkAdminVisibility();
        logoutBtn().style.display = 'block';
        sendBtn().disabled = false;
        inputEl().disabled = false;
      } else {
        window.location.href = '/login';
      }
    });

    async function checkAdminVisibility(){
      const link = adminLinkEl();
      if (!link) return;
      link.style.display = 'none';
      if (!idToken) return;
      try {
        const res = await fetch('/api/admin-data', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + idToken,
          },
        });
        if (res.ok) link.style.display = 'flex';
      } catch (e) {
        link.style.display = 'none';
      }
    }

    window.doLogout = async function () {
      await api('/api/logout', {});
      await signOut(auth);
    }

    window.sendMessage = sendMessage;
    window.handleKey = handleKey;
    window.newChat = async function(){
      await api('/api/clear', {});
      chatEl().innerHTML = '';
    }
  </script>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <img src="/static/unilingo-logo.svg" alt="UniLingo logo" />
        <span>UniLingo</span>
      </div>

      <div class="user-info">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-meta">
          <div class="user-name" id="user-name">Signed in</div>
        </div>
      </div>

      <button class="new-chat" onclick="newChat()">
        <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        <span>New chat</span>
      </button>

      <div class="history" id="history">
        <!-- Optional: conversation items could be rendered here -->
      </div>

      <div class="spacer"></div>

      <div class="nav-links">
        <a id="admin-link" class="side-btn" href="/admin" style="display:none">ðŸ“Š Admin</a>
      </div>

      <div class="user-card">
        <div style="font-weight:700">Signed in</div>
        <div id="whoami" class="email">Not signed in</div>
      </div>
      <button id="logout" class="logout" style="display:none" onclick="doLogout()">Logout</button>
    </aside>

    <!-- Chat area -->
    <section class="chat">
      <div class="chat-header">
        <div class="title-row">
          <div class="logo-dot" aria-hidden="true"></div>
          <div>
            <div class="chat-title">Smart Conversations</div>
            <div class="chat-sub">UniLingo Â· AI Language Hub</div>
          </div>
        </div>
        <div></div>
      </div>

      <div id="chat" class="chat-area"></div>

      <div class="composer">
        <textarea id="message" placeholder="What's in your mind?..." onkeydown="handleKey(event)" disabled></textarea>
        <button id="send" onclick="sendMessage()" disabled>â†’</button>
      </div>
    </section>
  </div>
</body>
</html>
